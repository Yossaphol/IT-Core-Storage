<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Overview</title>
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@100..900&family=Prompt:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
	<style>
		*{ font-family: "Prompt", sans-serif; }
		body { margin: 0; overflow: hidden; background-color: #0E1324; }
        canvas { display: block; }
        
        /* Custom scrollbar for the detail panel */
        #detail-panel::-webkit-scrollbar { width: 6px; }
        #detail-panel::-webkit-scrollbar-track { background: transparent; }
        #detail-panel::-webkit-scrollbar-thumb { background: #36498A; border-radius: 10px; }

		#detail-panel {
            -ms-overflow-style: none; /* IE and Edge */
            scrollbar-width: none; /* Firefox */
        }

		#detail-panel::-webkit-scrollbar {
			display: none; /* Chrome, Safari, and Opera */
		}
	</style>
</head>
<body>
	<div id="three-container" class="fixed inset-0 z-0"></div>

	<div class="relative z-40 pointer-events-none">
		<%- include('partials/header') %>
	</div>

	<div class="absolute top-[20%] left-[10%] text-white pointer-events-none">
		<p>ข้อมูล ณ คลังสินค้า [wh_id]</p>
		<p>สินค้าคงคลังทั้งหมด [st_count]</p>
		<p class="text-[#989898]">คลิกที่ชั้นวางเพื่อดูรายละเอียด</p>
	</div>
	
	<div class="absolute bottom-[5%] left-[10%] flex gap-10 pointer-events-none">
		<p class="text-[#989898]"> <i class="fa-solid fa-arrow-pointer text-white"></i> คลิกค้างแล้วลาก เพื่อย้ายมุมมอง</p>
		<p class="text-[#989898]"><i class="fa-solid fa-computer-mouse text-white"></i> เลื่อนล้อเมาส์ เพื่อซูมเข้า-ออก</p>
	</div>

	<div id="stock-popup" class="hidden absolute bottom-[12%] left-[10%] z-50 w-[320px] rounded-[16px] p-7 shadow-2xl backdrop-blur-md bg-gradient-to-b from-[#0E1324] to-[#36498A]/10 transition-all duration-300 transform scale-95 opacity-0 text-white">
		<h2 class="text-[34px] font-bold leading-tight tracking-wide">
			ชั้นวาง <span id="popup-stock-name"></span>
		</h2>
		<p class="text-[14px] italic text-white mb-4 font-light">ID: <span id="popup-stock-id"></span></p>		
		<div class="h-[1px] w-full bg-[#63BBF2]/30 mb-5"></div>
		<div class="space-y-2 mb-8 text-[17px]">
			<p class="font-bold">ประเภท: <span id="popup-stock-type"></span></p>
			<p>ตำแหน่ง: <span id="popup-stock-location"></span></p>
		</div>

		<div class="mb-6">
			<div class="flex justify-between items-end mb-2">
				<span class="font-bold text-[18px]">จำนวน</span>
				<span class="font-bold text-[18px]"><span id="popup-stock-current"></span>/<span id="popup-stock-max"></span></span>
			</div>
			<div class="w-full h-[10px] bg-white/90 rounded-full overflow-hidden">
				<div id="popup-stock-progress" class="h-full bg-[#6DE4B3] rounded-full transition-all duration-500"></div>
			</div>
		</div>
		<button onclick="showFullDetails()" class="w-full bg-[#6BB8E7] hover:bg-[#5AA9E2] text-[#0E1324] text-[18px] py-3 px-4 rounded-[10px] transition-colors flex justify-center items-center gap-2">
    		<i class="fa-regular fa-eye"></i> ดูรายละเอียด
		</button>
	</div>

	<div id="detail-panel" class="fixed top-0 right-0 h-full w-[450px] bg-[#0E1324]/95 backdrop-blur-xl border-l border-white/10 z-[30] transform translate-x-full transition-transform duration-500 ease-in-out text-white p-8  overflow-y-auto">
		<div class="flex justify-between items-start mb-6 mt-[100px]">
			<div>
				<h2 class="text-[40px] font-bold">ชั้นวาง <span id="detail-name">A1</span></h2>
				<p class="text-gray-400 italic">ID: <span id="detail-id">ST-A0001</span></p>
			</div>
		</div>

		<div class="flex gap-4 mb-8 text-[16px]">
			<p><span class="text-gray-400">ประเภท:</span> <span id="detail-type">RAM</span></p>
			<p><span class="text-gray-400">ขนาด:</span> S</p>
			<p class="col-span-2"><span class="text-gray-400">ตำแหน่ง:</span> <span id="detail-location">WH1-S1-A1</span></p>
		</div>

		<div class="mb-10">
			<div class="flex justify-between mb-2 font-bold">
				<span>จำนวน</span>
				<span><span id="detail-current">0</span>/<span id="detail-max">50</span></span>
			</div>
			<div class="w-full h-2 bg-white/20 rounded-full">
				<div id="detail-progress" class="h-full bg-[#6DE4B3] rounded-full transition-all duration-500" style="width: 0%;"></div>
			</div>
		</div>

		<div class="space-y-6">
			<div class="flex justify-between items-center border-b border-white/10 pb-2">
                <h3 class="text-lg text-gray-400">รายการสินค้า</h3>
                
                <div class="flex items-center gap-2 text-sm text-gray-400 hover:text-white transition-colors">
                    <i class="fa-solid fa-sort"></i>
                    <select id="product-sort" class="bg-transparent border-none cursor-pointer focus:ring-0 outline-none appearance-none text-left px-2 underline">
                        <option value="name-asc" class="bg-[#0E1324] text-white">เรียงตามชื่อ: A-Z</option>
                        <option value="name-desc" class="bg-[#0E1324] text-white">เรียงตามชื่อ: Z-A</option>
                        <option value="qty-desc" class="bg-[#0E1324] text-white">จำนวน: มาก-น้อย</option>
                        <option value="qty-asc" class="bg-[#0E1324] text-white">จำนวน: น้อย-มาก</option>
                        <option value="time-asc" class="bg-[#0E1324] text-white">เวลา: มาก่อน</option>
                        <option value="time-desc" class="bg-[#0E1324] text-white">เวลา: ล่าสุด</option>
                    </select>
                </div>
            </div>
			<div id="product-list" class="space-y-4"></div>
		</div>
	</div>

	<script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
                "gsap": "https://unpkg.com/gsap@3.12.5/index.js"
            }
        }
    </script>

	<script>
		const popup = document.getElementById('stock-popup');
        const detailPanel = document.getElementById('detail-panel');

		window.closePopup = function() {
			popup.classList.remove('scale-100', 'opacity-100');
			popup.classList.add('scale-95', 'opacity-0');
			setTimeout(() => { popup.classList.add('hidden'); }, 300);
		};

        // 1. Mock Data Array (Replace this with real database fetch later)
        let currentProducts = [
            {
                id: 'SKU-128897',
                name: 'RAM CORSAIR VENGEANCE RGB PRO SL 16GB (8x2) DDR4',
                brand: 'CORSAIR',
                qty: 12,
                time: 1670000000000, // Older timestamp
                img: 'https://m.media-amazon.com/images/I/61S6n67m9ML._AC_SL1500_.jpg'
            },
            {
                id: 'SKU-992341',
                name: 'KINGSTON FURY BEAST 32GB (16x2) DDR5 5200MHz',
                brand: 'Kingston',
                qty: 5,
                time: 1710000000000, // Mid timestamp
                img: 'https://m.media-amazon.com/images/I/71uVhw0P3aL._AC_SL1500_.jpg'
            },
            {
                id: 'SKU-551234',
                name: 'G.SKILL TRIDENT Z5 RGB 32GB (16x2) DDR5 6000MHz',
                brand: 'G.Skill',
                qty: 25,
                time: 1720000000000, // Newest timestamp
                img: 'https://m.media-amazon.com/images/I/61cQ-Hq14YL._AC_SL1500_.jpg'
            }
        ];

        function renderProducts(products) {
            const list = document.getElementById('product-list');
            list.innerHTML = products.map(p => `
                <div class="flex gap-4  p-4 items-center border-b border-[#4BA3E3]/30  transition-all">
                    <img src="${p.img}" class="w-20 h-20 object-contain bg-white rounded-md" />
                    <div class="text-[12px] flex-1">
                        <p class="text-gray-400">รหัสสินค้า: ${p.id}</p>
                        <p class="text-white leading-tight">${p.name}</p>
                        <div class="flex justify-between mt-2">
                            <span class="text-gray-400 cursor-pointer">แบรนด์ ${p.brand}</span>
                            <span class="text-white">จำนวน: ${p.qty}</span>
                        </div>
                    </div>
                </div>`).join('');
        }

        // 3. Sorting Event Listener
        document.getElementById('product-sort').addEventListener('change', function(e) {
            const sortBy = e.target.value;
            let sortedArray = [...currentProducts]; // Create a copy so we don't mutate the original array

            switch (sortBy) {
                case 'name-asc':
                    sortedArray.sort((a, b) => a.name.localeCompare(b.name, 'th'));
                    break;
                case 'name-desc':
                    sortedArray.sort((a, b) => b.name.localeCompare(a.name, 'th'));
                    break;
                case 'qty-desc':
                    sortedArray.sort((a, b) => b.qty - a.qty);
                    break;
                case 'qty-asc':
                    sortedArray.sort((a, b) => a.qty - b.qty);
                    break;
                case 'time-asc':
                    sortedArray.sort((a, b) => a.time - b.time);
                    break;
                case 'time-desc':
                    sortedArray.sort((a, b) => b.time - a.time);
                    break;
            }
            
            // Re-render the list with sorted data
            renderProducts(sortedArray);
        });

        // Logic to update the Detail Panel data
        window.updateDetailPanelData = function(data) {
            document.getElementById('detail-name').innerText = data.name;
            document.getElementById('detail-id').innerText = data.id;
            document.getElementById('detail-type').innerText = data.type;
            document.getElementById('detail-location').innerText = data.location;
            document.getElementById('detail-current').innerText = data.current;
            document.getElementById('detail-max').innerText = data.max;
            
            const percent = (data.current / data.max) * 100;
            document.getElementById('detail-progress').style.width = percent + '%';

            // Reset sort dropdown to default
            document.getElementById('product-sort').value = 'name-asc';
            
            // Initial render: Sort A-Z by default when panel opens
            let initialSort = [...currentProducts].sort((a, b) => a.name.localeCompare(b.name, 'th'));
            renderProducts(initialSort);
        };

        window.openStockPopup = function(data) {
			document.getElementById('popup-stock-name').innerText = data.name;
			document.getElementById('popup-stock-id').innerText = data.id;
			document.getElementById('popup-stock-type').innerText = data.type;
			document.getElementById('popup-stock-location').innerText = data.location;
			document.getElementById('popup-stock-current').innerText = data.current;
            document.getElementById('popup-stock-max').innerText = data.max;
			
            const percent = (data.current / data.max) * 100;
			document.getElementById('popup-stock-progress').style.width = percent + '%';

			popup.classList.remove('hidden');
            setTimeout(() => {
				popup.classList.remove('scale-95', 'opacity-0');
				popup.classList.add('scale-100', 'opacity-100');
			}, 10);

            // AUTO-UPDATE: If the detail panel is already open, refresh its data immediately
            if (!detailPanel.classList.contains('translate-x-full')) {
                window.updateDetailPanelData(data);
            }
		};

        window.showFullDetails = function() {
            // Get current data from the small popup
            const currentData = {
                name: document.getElementById('popup-stock-name').innerText,
                id: document.getElementById('popup-stock-id').innerText,
                type: document.getElementById('popup-stock-type').innerText,
                location: document.getElementById('popup-stock-location').innerText,
                current: document.getElementById('popup-stock-current').innerText,
                max: document.getElementById('popup-stock-max').innerText
            };
            
            window.updateDetailPanelData(currentData);
            detailPanel.classList.remove('translate-x-full');
        };

        window.closeDetailPanel = function() {
            detailPanel.classList.add('translate-x-full');
        };
	</script>

    <script type="module" src="/view_stock/StockBlock_main.js"></script>
</body>
</html>